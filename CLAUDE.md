# devcontainer-features

## Overview

A Dev Container Feature that installs MySQL Shell (`mysqlsh`).
Follows the conventions of [devcontainers/feature-starter](https://github.com/devcontainers/feature-starter).
Personal project.

## Repository Structure

```
devcontainer-features/
├── src/mysqlsh/
│   ├── devcontainer-feature.json   # Feature metadata (current version: 1.0.0)
│   ├── install.sh                  # Install script
│   ├── README.md                   # Auto-generated feature documentation (do not edit manually)
│   └── NOTES.md                    # Additional docs appended to README.md on release
├── test/mysqlsh/
│   ├── test.sh                     # Autogenerated test (verifies default behavior)
│   ├── scenarios.json              # Test scenario definitions (9 scenarios)
│   ├── install_default_ubuntu_jammy.sh
│   ├── install_84_ubuntu_jammy.sh
│   ├── install_80_ubuntu_jammy.sh
│   ├── install_default_ubuntu_noble.sh
│   ├── install_84_ubuntu_noble.sh
│   ├── install_80_ubuntu_noble.sh
│   ├── install_default_debian_bookworm.sh
│   ├── install_84_debian_bookworm.sh
│   └── install_80_debian_bookworm.sh
├── .devcontainer/
│   └── devcontainer.json           # Dev environment for this repository itself
├── .shellcheckrc                   # ShellCheck config (disables SC1091 for test lib)
└── .github/workflows/
    ├── test.yaml                   # CI tests (auto-runs on push/PR)
    ├── lint.yaml                   # ShellCheck for src/ and test/ (auto-runs on push/PR)
    ├── release.yaml                # GHCR publish + docs generation (manual trigger, requires CI to pass)
    ├── validate.yaml               # devcontainer-feature.json validation (push/PR/manual)
    └── update-versions.yaml        # Monthly auto-update of arm64 fallback versions (scheduled)
```

## install.sh Behavior

### Version Option (`version`)

| Value | Series installed |
|---|---|
| `latest` (default) | 8.4 LTS |
| `8.0` | MySQL Shell 8.0 |
| `8.4` | MySQL Shell 8.4 LTS |

Internally, version values map to series names: `8.0` or `8.4`.

### Install Method by Architecture

| Architecture | Method |
|---|---|
| amd64 + Debian/Ubuntu | APT via `mysql-apt-config_0.8.36-1_all.deb` |
| arm64 + Debian/Ubuntu | Linux Generic tarball (`arm-64bit` naming, extracted to `/opt/`) |
| Alpine / RHEL-family / other | Error exit |

For distros not explicitly matched by `ID`, the script falls back to checking `ID_LIKE` to handle Debian/Ubuntu derivatives.

### arm64 Version Resolution

Fetches the exact version from the GitHub Releases API (`https://api.github.com/repos/mysql/mysql-shell/releases?per_page=100`).
Fallback versions used when the API is unavailable (auto-updated monthly by `update-versions.yml`):

| Series | Fallback |
|---|---|
| latest / 8.4 | `8.4.8` |
| 8.0 | `8.0.44` |

### arm64 SHA256 Verification

After downloading the tarball, the installer attempts a best-effort SHA256 checksum verification by fetching `${url}.sha256`. If the checksum file is unavailable, verification is skipped and HTTPS transport security is relied upon.

## Test Configuration

### Scenario Matrix (3 OS × 3 versions = 9 scenarios)

| Version | ubuntu:jammy | ubuntu:noble | debian:bookworm |
|---|---|---|---|
| default | ✅ | ✅ | ✅ |
| 8.0 | ✅ | ✅ | ✅ |
| 8.4 | ✅ | ✅ | ✅ |

### Running Tests

```bash
# Autogenerated test (default behavior only)
devcontainer features test \
  --features mysqlsh \
  --base-image ubuntu:jammy \
  --skip-scenarios \
  .

# Specific scenario
devcontainer features test \
  --features mysqlsh \
  --filter install_84_ubuntu_noble \
  .

# All scenarios
devcontainer features test \
  --features mysqlsh \
  .
```

### CI (test.yaml)

Uses `@devcontainers/cli@0.83.0` (pinned).

- **test-autogenerated**: 3 OS × 2 runners (amd64 + arm64) = 6 jobs
- **test-scenarios**: 9 scenarios × 2 runners = 18 jobs
- Total: 24 jobs. Runs automatically on push and pull requests.

## Publishing to GHCR

Manually trigger the `release.yaml` workflow (`workflow_dispatch`) from GitHub.
The workflow first verifies that the latest CI run on `main` succeeded before publishing.
Uses `devcontainers/action` (v1.4.3, pinned by commit hash) to auto-detect Features under `src/` and publish to GHCR.
Also auto-generates `src/*/README.md` (with `NOTES.md` appended) and opens a PR for the documentation update.

Usage after publishing:
```json
"features": {
    "ghcr.io/191hibino/devcontainer-features/mysqlsh:1": { "version": "8.4" }
}
```

### Authentication

| Environment | Auth required |
|---|---|
| GitHub Codespaces | None (automatic) |
| Local Dev Containers | `docker login ghcr.io` on first use |
| GitHub Actions (same org) | None (automatic via `GITHUB_TOKEN`) |

## Security Measures

- **`set -euo pipefail`**: Strict shell mode; unbound variables and pipeline failures are fatal
- **GitHub Actions hash pinning**: Actions referenced by commit hash, not tag
- **Dual GPG keys**: Both MySQL 2022 and 2025 signing keys imported for resilience
- **GitHub API pagination**: `?per_page=100` ensures complete release listing
- **arm64 SHA256 verification**: Best-effort checksum check after tarball download
- **release.yaml CI gate**: Requires passing CI on `main` before publishing
- **Dependabot**: Monthly automated dependency updates for GitHub Actions

## Development Workflow

### Adding or Changing Functionality

1. Edit `src/mysqlsh/install.sh`
2. Add or update test scripts in `test/mysqlsh/`
3. Run tests locally: `devcontainer features test --features mysqlsh .`
4. Lint: `shellcheck src/mysqlsh/install.sh` (or rely on CI lint.yaml)
5. Bump `version` in `src/mysqlsh/devcontainer-feature.json`
6. Commit and push to GitHub
7. CI runs automatically (tests, lint, validation)

### Releasing

1. Update `version` in `src/mysqlsh/devcontainer-feature.json` to `X.Y.Z`
2. Push to `main` and ensure CI passes
3. Manually run the `release.yaml` workflow on GitHub
4. Package is published to GHCR; a PR is opened for any documentation updates

### Updating Feature Documentation

Edit `src/mysqlsh/NOTES.md` to add persistent notes (supported platforms, known limitations, troubleshooting).
`src/mysqlsh/README.md` is auto-generated on release and will be overwritten — do not edit it directly.
